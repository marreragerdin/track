{% extends 'base.html' %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}
<style>
    .dashboard-container { display:flex; flex-direction:column; gap:1.5rem; margin-top:1.5rem; }
    .faculty-heading { color:#152E21; font-weight:600; font-size:1.75rem; font-family:Inter, sans-serif; }
    .faculty-subheading { color:#616161; font-size:0.95rem; }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; }
    .stat-card { background:#F6F5AE; color:#152E21; padding:1rem; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }

    .section-container { background:#FFFFFF; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden; }
    .section-header { background-color:#F6F5AE; color:#152E21; padding:1rem 1.25rem; font-weight:600; display:flex; align-items:center; gap:0.75rem; }
    .section-body { padding:1.25rem; }

    .faculty-table { width:100%; border-collapse:collapse; }
    .faculty-table thead { background:#d9d9d9; color:#152E21; }
    .faculty-table thead th { padding:0.75rem; text-align:left; font-weight:600; }
    .faculty-table tbody td { padding:0.75rem; border-bottom:1px solid #f0f0f0; color:#1E1E1E;  font-size: 0.8rem; text-align: right;}
    
    .faculty-table thead th {
        padding: 20px;
        font-size: 0.8rem;
        text-align: left;
        color: #152E21;
    }
    .adviser-alert {
        padding: 2rem;
        border: 1px solid #152E21;
        border-radius: 24px;
        margin-bottom: 2rem;
    }

    .adviser-alert i {
      margin-right: 0.5rem;
    }

    @media (max-width:768px){ .stats-grid{grid-template-columns:1fr} .section-header{font-size:0.95rem} }

    .status-badge {
        display: inline-block;
        padding: 3px 14px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.8rem;
        font-family: Poppins, sans-serif;
        text-align: center;
        white-space: nowrap;
        margin-bottom: 0.5rem;
    }
    .status-badge-at-risk {
        background-color: #EF5353;
        color: #FFFFFF;
    }
    .status-badge-average {
        background-color: #F39E4D;
        color: #FFFFFF;
    }
    .status-badge-good {
        background-color: #F0EB5B;
        color: #FFFFFF;
    }
    .status-badge-excellent {
        background-color: #a8cc45;
        color: #FFFFFF;
    }

    /* Responsive table stacking */
    @media (max-width:600px){
        .faculty-table thead{display:none}
        .faculty-table, .faculty-table tbody, .faculty-table tr, .faculty-table td{display:block;width:100%}
        .faculty-table tr{margin-bottom:1rem;border:1px solid #f0f0f0;border-radius:8px;padding:0.5rem}
        .faculty-table td{padding:0.5rem;display:flex;justify-content:space-between}
        .faculty-table td::before{content:attr(data-label);color:#616161;font-weight:600;margin-right:0.75rem}
    }
</style>

<div class="dashboard-container container">
    <div>
        <h1 class="faculty-heading">My Dashboard</h1>
        <p class="faculty-subheading">Welcome, {{ user.get_full_name|default:user.username }}</p>
    </div>

    {% if student_record %}
    <div class="section-container">
        <div class="section-header"><i class="fas fa-user-graduate"></i> Student Information</div>
        <div class="section-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Student ID:</strong> {{ student_record.student_id }}</p>
                    <p><strong>Full Name:</strong> {{ student_record.fullname }}</p>
                    <p><strong>Grade & Section:</strong> {{ student_record.grade_and_section }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Gender:</strong> {{ student_record.gender }}</p>
                    <p><strong>Age:</strong> {{ student_record.age }}</p>
                    <p><strong>Status:</strong> {{ student_record.status }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="section-container">
        <div class="section-header"><i class="fas fa-chart-line"></i> My Scores & Grades</div>
        <div class="section-body">
            {% if student_subjects %}
                {% for subject_data in student_subjects %}
                    {% if subject_data.auto_category == 'At Risk' or subject_data.performance_category == 'At Risk' %}
                        <div class="adviser-alert"><strong><i class="fas fa-exclamation-triangle"></i> At Risk Alert:</strong> Your grade in <strong>{{ subject_data.subject.name }}</strong> is below 70. Please seek help from your teacher.</div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <div class="table-wrapper">
                <table class="faculty-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Quiz Avg</th>
                            <th>Exam Avg</th>
                            <th>Project Avg</th>
                            <th>Attendance</th>
                            <th>Overall</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subject_data in student_subjects %}
                        {% with status=subject_data.auto_category|default:subject_data.performance_category %}
                        <tr>
                            <td data-label="Subject"><strong>{{ subject_data.subject.name }} ({{ subject_data.subject.code }})</strong></td>
                            <td data-label="Quiz Avg">{% if subject_data.quiz_average %}{{ subject_data.quiz_average|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                            <td data-label="Exam Avg">{% if subject_data.exam_average %}{{ subject_data.exam_average|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                            <td data-label="Project Avg">{% if subject_data.project_average %}{{ subject_data.project_average|floatformat:2 }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                            <td data-label="Attendance">{% if subject_data.attendance_average %}{{ subject_data.attendance_average|floatformat:2 }}%{% else %}<span class="text-muted">-</span>{% endif %}</td>
                            <td data-label="Overall">{% if subject_data.grade %}<strong>{{ subject_data.grade|floatformat:2 }}</strong>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                            <td data-label="Status">
                                {% if status %}
                                    {% if status == 'At Risk' %}
                                        <span class="status-badge status-badge-at-risk">At Risk</span>
                                    {% elif status == 'Average' %}
                                        <span class="status-badge status-badge-average">Average</span>
                                    {% elif status == 'Good' %}
                                        <span class="status-badge status-badge-good">Good</span>
                                    {% elif status == 'Excellent' %}
                                        <span class="status-badge status-badge-excellent">Excellent</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endwith %}
                        {% empty %}
                        <tr><td colspan="7" class="text-center">No scores available yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <h4>Student Record Not Found</h4>
        <p>Your student record could not be found. Please contact the administrator.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

