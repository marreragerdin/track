{% extends 'base.html' %}
{% load static %}
{% block title %}Academic Setup{% endblock %}

{% block content %}
  <div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h2>Academic Setup</h2>
    <a href="{% url 'adminpage' %}" class="btn btn-secondary">Go Back</a>
  </div>

  <ul class="nav nav-tabs mt-3">
    <li class="nav-item"><a class="nav-link {% if tab == 'school_year' %}active{% endif %}" href="?tab=school_year">School Year</a></li>
    <li class="nav-item"><a class="nav-link {% if tab == 'subject' %}active{% endif %}" href="?tab=subject">Subjects</a></li>
    <li class="nav-item"><a class="nav-link {% if tab == 'section' %}active{% endif %}" href="?tab=section">Sections</a></li>
    <li class="nav-item"><a class="nav-link {% if tab == 'faculty' %}active{% endif %}" href="?tab=faculty">Faculty Assignment</a></li>
    <li class="nav-item"><a class="nav-link {% if tab == 'grading' %}active{% endif %}" href="?tab=grading">Grading Setup</a></li>
  </ul>

  <div class="mt-3">
    <!-- Action bar -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        {% if tab == 'school_year' %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSchoolYearModal">Add School Year</button>
        {% elif tab == 'subject' %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSubjectModal">Add Subject</button>
        {% elif tab == 'section' %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSectionModal">Add Section</button>
        {% elif tab == 'faculty' %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFacultyModal">Assign Faculty</button>
        {% elif tab == 'grading' %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGradingModal">Add Component</button>
        {% endif %}
      </div>

    </div>

    <hr>
    <h5>Existing Records</h5>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          {% if tab == 'school_year' %}
            <tr><th>Year</th><th>Status</th><th>Actions</th></tr>
          {% elif tab == 'subject' %}
            <tr><th>Code</th><th>Name</th><th>Status</th><th>Actions</th></tr>
          {% elif tab == 'section' %}
            <tr><th>Grade</th><th>Section</th><th>Adviser</th><th>No. Students</th><th>Status</th><th>Actions</th></tr>
          {% elif tab == 'faculty' %}
            <tr><th>Subject</th><th>Faculty</th><th>Status</th><th>Actions</th></tr>
          {% elif tab == 'grading' %}
            <tr><th>Component</th><th>Weight</th><th>Status</th><th>Actions</th></tr>
          {% endif %}
        </thead>
        <tbody>
  {% for obj in page_obj %}
    <tr>
      {% if tab == 'school_year' %}
        <td>{{ obj.year }}</td>
        <td>{{ obj.status }}</td>
        <td>
          <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editSchoolYearModal{{ obj.id }}">Edit</button>
          <a href="{% url 'delete_school_year' obj.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this school year?')">Delete</a>
        </td>
      {% elif tab == 'subject' %}
        <td>{{ obj.code }}</td>
        <td>{{ obj.name }}</td>
        <td>{{ obj.status }}</td>
        <td>
          <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editSubjectModal{{ obj.id }}">Edit</button>
          <a href="{% url 'delete_subject' obj.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this subject?')">Delete</a>
        </td>
      {% elif tab == 'section' %}
        <td>{{ obj.grade }}</td>
        <td>{{ obj.name }}</td>
        <td>{{ obj.adviser }}</td>
        <td>{{ obj.number_of_students }}</td>
        <td>{{ obj.status }}</td>
        <td>
          <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editSectionModal{{ obj.id }}">Edit</button>
          <a href="{% url 'delete_section' obj.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this section?')">Delete</a>
        </td>
      {% elif tab == 'faculty' %}
        <td>
          {% for sub in obj.subjects.all %}
            {{ sub.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
            None
          {% endfor %}
        </td>
        <td>{{ obj.faculty.get_full_name|default:obj.faculty.username }}</td>
        <td>{{ obj.status }}</td>
        <td>
          <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editFacultyAssignmentModal{{ obj.id }}">Edit</button>
          <a href="{% url 'delete_faculty' obj.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this faculty assignment?')">Delete</a>
        </td>


      {% elif tab == 'grading' %}
        <td>{{ obj.component }}</td>
        <td>{{ obj.weight }}%</td>
        <td>{{ obj.status }}</td>
        <td>
          <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editGradingModal{{ obj.id }}">Edit</button>
          <a href="{% url 'delete_grading' obj.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this grading component?')">Delete</a>
        </td>
      {% endif %}
    </tr>
  {% empty %}
    <tr><td colspan="6">No records</td></tr>
  {% endfor %}
</tbody>

      </table>
    </div>
    
    <!-- Pagination -->
    {% if page_obj %}
    <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?tab={{ tab }}&page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?tab={{ tab }}&page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?tab={{ tab }}&page={{ page_obj.next_page_number }}">Next</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
  </div>
</div>

<!-- Modals -->
{% include 'modals/add_school_year_modal.html' with modal_id='addSchoolYearModal' modal_title='Add School Year' form_action='/academic/school-year/add/' years=years %}
{% include 'modals/add_subject_modal.html' with modal_id='addSubjectModal' modal_title='Add Subject' form_action='/academic/subject/add/' %}
{% include 'modals/add_section_modal.html' with modal_id='addSectionModal' modal_title='Add Section' form_action='/academic/section/add/' %}
{% include 'modals/add_faculty_modal.html' with modal_id='addFacultyModal' modal_title='Assign Faculty' form_action='/academic/faculty/add/' faculties=faculties subjects_qs=subjects_qs %}
{% include 'modals/add_grading_modal.html' with modal_id='addGradingModal' modal_title='Add Grading Component' form_action='/academic/grading/add/' %}

<!-- Edit Modals -->
{% for obj in objects %}
    {% if tab == 'school_year' %}
        {% include 'modals/edit_school_year_modal.html' with obj=obj years=years %}
    {% elif tab == 'subject' %}
        {% include 'modals/edit_subject_modal.html' with obj=obj %}
    {% elif tab == 'section' %}
        {% include 'modals/edit_section_modal.html' with obj=obj %}
    {% elif tab == 'grading' %}
        {% include 'modals/edit_grading_modal.html' with obj=obj %}
    {% endif %}
{% endfor %}
{% if tab == 'faculty' %}
    {% for obj in objects %}
        {% include 'modals/edit_faculty_assignment_modal.html' with obj=obj faculties=faculties subjects_qs=subjects_qs %}
    {% endfor %}
{% endif %}

<script>
// Ensure modals are properly initialized and forms have data-modal-form attribute
document.addEventListener('DOMContentLoaded', function() {
    // Set data-modal-form on all modal forms
    document.querySelectorAll('.modal form').forEach(function(form) {
        form.setAttribute('data-modal-form', 'true');
    });
    
    // Ensure Bootstrap modals work - this is handled by Bootstrap automatically
    // but we can verify modals exist
    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(function(button) {
        button.addEventListener('click', function() {
            const modalId = this.getAttribute('data-bs-target');
            const modalElement = document.querySelector(modalId);
            if (!modalElement) {
                console.error('Modal not found:', modalId);
            }
        });
    });
});
</script>
{% endblock %}
