{% extends 'base.html' %}
{% load static %}
{% block title %}Student Record{% endblock %}

{% block content %}
    <h2>Student Record</h2>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentRecordModal">Add Student</button>

<div class = "table-responsive">
<table class="table table-hover">
  <tbody>
    <tr>
      <th scope="col">Student ID</th>
      <th scope="col">Fullname</th>
      <th scope="col">Grade & Section</th>
      <th scope="col">Gender</th>
       <th scope="col">Age</th>
      <th scope="col">Address</th>
      <th scope="col">Parent/Guardian</th>
      <th scope="col">Parent/Guardian Contact</th>
       <th scope="col">Status</th>
      <th scope="col">Actions</th>
    </tr>
  </tbody>
  {% for student in page_obj %}
  <tr>
    <td>{{ student.student_id}}</td>
    <td>{{ student.fullname}}</td>
    <td>{{ student.grade_and_section}}</td>
    <td>{{ student.gender}}</td>
    <td>{{ student.age}}</td>
    <td>{{ student.address}}</td>
    <td>{{ student.parent}}</td>
    <td>{{ student.parent_contact}}</td>
    <td>{{ student.status}}</td>
    <td>
<button type="button"
        class="btn btn-success me-1"
        data-bs-toggle="modal"
        data-bs-target="#mymodal{{student.id}}">
  <i class="fa-solid fa-circle-info"></i>
</button>

<!--      modal view student-->
  <div class="modal" id ="mymodal{{student.id}}" tabindex="-1" aria-labelledby="mymodalLabel{{student.id}}" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Student: {{ student.fullname}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true"></span>
        </button>
      </div>
      <div class="modal-body">
        <ul class="list-unstyled">
          <li>Student ID: <strong> {{ student.student_id}} </strong></li>
          <li>Fullname: <strong> {{ student.fullname}}</strong></li>
          <li>Grade & Section: <strong> {{ student.grade_and_section}}</strong></li>
          <li>Gender: <strong> {{ student.gender}}</strong></li>
          <li>Age: <strong> {{ student.age}}</strong></li>
          <li>Address: <strong> {{ student.address}}</strong></li>
          <li>Parent/Guardian: <strong> {{ student.parent}}</strong></li>
          <li>Parent/Guardian Contact: <strong> {{ student.parent_contact}}</strong></li>
          <li>Status: <strong> {{ student.status}}</strong></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!--      modal delete student-->
      <button type="button" class="btn btn-warning me-1 edit-student-btn" data-student-id="{{ student.id }}">
        <i class="fa-solid fa-pen-to-square"></i>
      </button>
      <button type="button" class="btn btn-danger" data-bs-toggle = "modal" data-bs-target="#delete{{student.id}}">
        <i class="fa-solid fa-trash-can"></i>
      </button>
      <div class="modal" id ="delete{{student.id}}" tabindex="-1" aria-labelledby="mymodalLabel{{student.id}}" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Student: {{ student.fullname}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true"></span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this student?</p>
      </div>
     <div class="modal-footer">
  <form action="{% url 'delete' student.id %}" method="POST">
    {% csrf_token %}
    <input type="submit" class="btn btn-danger" value="Delete">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  </form>
</div>

      </div>
    </div>
  </div>
</div>

    </td>
  </tr>
  {%endfor%}
</table>

<!-- Pagination -->
{% if page_obj %}
<nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentRecordModal" tabindex="-1" aria-labelledby="addStudentRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Modal - Dynamic -->
<div class="modal fade" id="editStudentRecordModal" tabindex="-1" aria-labelledby="editStudentRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load add student record modal dynamically
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.querySelector('[data-bs-target="#addStudentRecordModal"]');
    if (addBtn) {
        addBtn.addEventListener('click', function() {
            const modalElement = document.getElementById('addStudentRecordModal');

            // Load fresh modal content each time
            fetch('{% url "add" %}', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // Prefer a full modal structure if present, otherwise modal-content
                const fullModal = tempDiv.querySelector('.modal');
                let contentHtml = null;
                if (fullModal) {
                    const modalContent = fullModal.querySelector('.modal-content');
                    if (modalContent) contentHtml = modalContent.innerHTML;
                }
                if (!contentHtml) {
                    const modalContentDirect = tempDiv.querySelector('.modal-content');
                    if (modalContentDirect) contentHtml = modalContentDirect.innerHTML;
                }

                const targetContent = modalElement.querySelector('.modal-content');
                if (targetContent && contentHtml !== null) {
                    targetContent.innerHTML = contentHtml;
                    attachFormHandler(modalElement);
                    // Re-initialize scripts after content is loaded
                    if (typeof initStudentRecordModal === 'function') {
                        setTimeout(initStudentRecordModal, 100);
                    }
                } else if (targetContent) {
                    // Fallback: inject raw HTML if structure differs
                    targetContent.innerHTML = html;
                    attachFormHandler(modalElement);
                }
            })
            .catch(error => {
                console.error('Error loading modal:', error);
            });
        });
    }

    // Handle edit student record button clicks (delegated)
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.edit-student-btn');
        if (btn) {
            const studentId = btn.dataset.studentId;
            const modalElement = document.getElementById('editStudentRecordModal');

            fetch(`/edit/${studentId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                const fullModal = tempDiv.querySelector('.modal');
                let contentHtml = null;
                if (fullModal) {
                    const modalContent = fullModal.querySelector('.modal-content');
                    if (modalContent) contentHtml = modalContent.innerHTML;
                }
                if (!contentHtml) {
                    const modalContentDirect = tempDiv.querySelector('.modal-content');
                    if (modalContentDirect) contentHtml = modalContentDirect.innerHTML;
                }

                const targetContent = modalElement.querySelector('.modal-content');
                if (targetContent && contentHtml !== null) {
                    targetContent.innerHTML = contentHtml;
                    attachFormHandler(modalElement);
                    const bootstrapModal = new bootstrap.Modal(modalElement);
                    bootstrapModal.show();
                } else if (targetContent) {
                    // Fallback: inject raw HTML
                    targetContent.innerHTML = html;
                    attachFormHandler(modalElement);
                    const bootstrapModal = new bootstrap.Modal(modalElement);
                    bootstrapModal.show();
                }
            })
            .catch(error => {
                console.error('Error loading edit modal:', error);
            });
        }
    });

    // Attach form submission handler to prevent normal POST and handle via AJAX
    function attachFormHandler(modalElement) {
        const form = modalElement.querySelector('form');
        if (form && form.getAttribute('data-modal-form') === 'true') {
            // Remove any previously attached handler to avoid duplicates
            if (form._attachedHandler) {
                form.removeEventListener('submit', form._attachedHandler);
            }

            const handler = function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                const actionUrl = form.getAttribute('action');

                fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(async response => {
                    // Try to parse JSON; if it isn't JSON, return text
                    const ct = response.headers.get('content-type') || '';
                    if (ct.includes('application/json')) return response.json();
                    const text = await response.text();
                    return { success: false, message: 'Invalid server response', _raw: text };
                })
                .then(data => {
                    if (data && data.success) {
                        // If server returned HTML for the new row, insert it into the table
                        if (data.row_html) {
                            let tbody = document.getElementById('students-tbody');
                            if (!tbody) {
                                // If tbody doesn't exist, try to find the table and create tbody
                                const table = document.querySelector('.table.table-hover');
                                if (table) {
                                    tbody = table.querySelector('tbody') || document.createElement('tbody');
                                    if (!table.querySelector('tbody')) table.appendChild(tbody);
                                    tbody.id = 'students-tbody';
                                }
                            }
                            if (tbody) {
                                tbody.insertAdjacentHTML('afterbegin', data.row_html);
                            }
                        }

                        // If server returned modal HTML (edit modal), append it to body so edit works
                        if (data.modal_html) {
                            document.body.insertAdjacentHTML('beforeend', data.modal_html);
                        }

                        // Close modal
                        const bsModal = bootstrap.Modal.getInstance(modalElement);
                        if (bsModal) bsModal.hide();

                        // Attach handlers for the newly inserted edit modal if server provided student_id
                        if (data.student_id) {
                            const newEditModal = document.getElementById('editStudentRecordModal' + data.student_id);
                            if (newEditModal) {
                                attachFormHandler(newEditModal);
                            }
                        }

                        // Show friendly message
                        if (data.message) {
                            // small inline notification could go here; using alert for parity
                            alert(data.message);
                        }
                    } else {
                        // Show validation errors if provided
                        if (data && data.errors) {
                            let errMsg = data.message || 'Validation failed';
                            for (const [field, messages] of Object.entries(data.errors)) {
                                errMsg += '\n' + field + ': ' + messages.join(', ');
                            }
                            alert(errMsg);
                        } else {
                            alert((data && data.message) || 'Error saving form');
                        }
                    }
                })
                .catch(error => {
                    console.error('Form submission error:', error);
                    alert('Error saving form');
                });
            };

            form.addEventListener('submit', handler);
            form._attachedHandler = handler;
        }
    }
});
</script>


{% endblock %}
