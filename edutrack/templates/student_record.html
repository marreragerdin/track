{% extends 'base.html' %}
{% load static %}
{% block title %}Student Record{% endblock %}

{% block content %}
    <h2>Student Record</h2>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentRecordModal">Add Student</button>

<div class = "table-responsive">
<table class="table table-hover">
  <tbody>
    <tr>
      <th scope="col">Student ID</th>
      <th scope="col">Fullname</th>
      <th scope="col">Grade & Section</th>
      <th scope="col">Gender</th>
       <th scope="col">Age</th>
      <th scope="col">Address</th>
      <th scope="col">Parent/Guardian</th>
      <th scope="col">Parent/Guardian Contact</th>
       <th scope="col">Status</th>
      <th scope="col">Actions</th>
    </tr>
  </tbody>
  {% for student in page_obj %}
  <tr>
    <td>{{ student.student_id}}</td>
    <td>{{ student.fullname}}</td>
    <td>{{ student.grade_and_section}}</td>
    <td>{{ student.gender}}</td>
    <td>{{ student.age}}</td>
    <td>{{ student.address}}</td>
    <td>{{ student.parent}}</td>
    <td>{{ student.parent_contact}}</td>
    <td>{{ student.status}}</td>
    <td>
<button type="button"
        class="btn btn-success me-1"
        data-bs-toggle="modal"
        data-bs-target="#mymodal{{student.id}}">
  <i class="fa-solid fa-circle-info"></i>
</button>

<!--      modal view student-->
  <div class="modal" id ="mymodal{{student.id}}" tabindex="-1" aria-labelledby="mymodalLabel{{student.id}}" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Student: {{ student.fullname}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true"></span>
        </button>
      </div>
      <div class="modal-body">
        <ul class="list-unstyled">
          <li>Student ID: <strong> {{ student.student_id}} </strong></li>
          <li>Fullname: <strong> {{ student.fullname}}</strong></li>
          <li>Grade & Section: <strong> {{ student.grade_and_section}}</strong></li>
          <li>Gender: <strong> {{ student.gender}}</strong></li>
          <li>Age: <strong> {{ student.age}}</strong></li>
          <li>Address: <strong> {{ student.address}}</strong></li>
          <li>Parent/Guardian: <strong> {{ student.parent}}</strong></li>
          <li>Parent/Guardian Contact: <strong> {{ student.parent_contact}}</strong></li>
          <li>Status: <strong> {{ student.status}}</strong></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!--      modal delete student-->
      <button type="button" class="btn btn-warning me-1" data-bs-toggle="modal" data-bs-target="#editStudentRecordModal{{ student.id }}" data-modal-load="{% url 'edit' student.id %}">
        <i class="fa-solid fa-pen-to-square"></i>
      </button>
      <button type="button" class="btn btn-danger" data-bs-toggle = "modal" data-bs-target="#delete{{student.id}}">
        <i class="fa-solid fa-trash-can"></i>
      </button>
      <div class="modal" id ="delete{{student.id}}" tabindex="-1" aria-labelledby="mymodalLabel{{student.id}}" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Student: {{ student.fullname}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true"></span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this student?</p>
      </div>
     <div class="modal-footer">
  <form action="{% url 'delete' student.id %}" method="POST">
    {% csrf_token %}
    <input type="submit" class="btn btn-danger" value="Delete">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  </form>
</div>

      </div>
    </div>
  </div>
</div>

    </td>
  </tr>
  {%endfor%}
</table>

<!-- Pagination -->
{% if page_obj %}
<nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
</div>


<!-- Add Student Modal - will be loaded dynamically -->
<div class="modal fade" id="addStudentRecordModal" tabindex="-1" aria-labelledby="addStudentRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Modal loading helpers and AJAX submit handler
document.addEventListener('DOMContentLoaded', function() {
    function htmlToElement(html) {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        return temp;
    }

    function runInlineScripts(container) {
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
            try {
                const newScript = document.createElement('script');
                if (oldScript.src) {
                    newScript.src = oldScript.src;
                    newScript.async = false;
                    document.head.appendChild(newScript);
                } else {
                    newScript.text = oldScript.textContent;
                    document.body.appendChild(newScript);
                    document.body.removeChild(newScript);
                }
            } catch (e) {
                console.error('Error running inline script', e);
            }
        });
    }

    // Global initializer used by both Add and Edit modals to wire grade->section behavior
    function initStudentRecordModal() {
        // For each grade select inside modal-content, attach change handler
        document.querySelectorAll('[id^="id_grade_level_record"]').forEach(function(gradeSelect) {
            const modalContent = gradeSelect.closest('.modal-content') || document;
            const sectionSelect = modalContent.querySelector('[id^="id_section_record"]');
            if (!sectionSelect) return;

            // On change: fetch sections for selected grade
            gradeSelect.addEventListener('change', function() {
                const grade = this.value;
                if (!grade) return;
                fetch(`/api/sections/?grade=${encodeURIComponent(grade)}`)
                    .then(r => r.json())
                    .then(data => {
                        sectionSelect.innerHTML = '<option value="">Select Section</option>';
                        if (data.sections && data.sections.length) {
                            data.sections.forEach(s => {
                                const opt = document.createElement('option');
                                opt.value = s.id;
                                opt.text = s.name;
                                sectionSelect.appendChild(opt);
                            });
                        }
                    })
                    .catch(err => console.error('Error fetching sections', err));
            });

            // On init: if there are no options (or only placeholder), try to populate based on current grade value
            const hasRealOptions = Array.from(sectionSelect.options).some(o => o.value);
            if (!hasRealOptions && gradeSelect.value) {
                const currentGrade = gradeSelect.value;
                // attempt to get the original section name from modal dataset
                const modalRoot = gradeSelect.closest('.modal');
                const currentSectionName = modalRoot ? (modalRoot.dataset.currentSection || '') : '';
                fetch(`/api/sections/?grade=${encodeURIComponent(currentGrade)}`)
                    .then(r => r.json())
                    .then(data => {
                        sectionSelect.innerHTML = '<option value="">Select Section</option>';
                        if (data.sections && data.sections.length) {
                            data.sections.forEach(s => {
                                const opt = document.createElement('option');
                                opt.value = s.id;
                                opt.text = s.name;
                                if (currentSectionName && s.name === currentSectionName) opt.selected = true;
                                sectionSelect.appendChild(opt);
                            });
                        }
                    })
                    .catch(err => console.error('Error fetching sections', err));
            }
        });

        // Wire 'Also create user account' checkbox to show/hide account fields inside the modal
        document.querySelectorAll('.modal-content').forEach(modalContent => {
            try {
                const checkbox = modalContent.querySelector('input[name="create_account"]');
                const accountFields = modalContent.querySelector('#account_fields');
                const passwordInput = modalContent.querySelector('input[name="password"], input#password');
                if (!checkbox || !accountFields) return;

                const usernameInput = modalContent.querySelector('input[name="username"], input#username');
                const updateAccountFields = () => {
                    if (checkbox.checked) {
                        accountFields.style.display = '';
                        if (passwordInput) passwordInput.required = true;
                        if (usernameInput) usernameInput.required = true;
                    } else {
                        accountFields.style.display = 'none';
                        if (passwordInput) passwordInput.required = false;
                        if (usernameInput) usernameInput.required = false;
                    }
                };

                // initialize state
                updateAccountFields();
                // listen for changes
                checkbox.addEventListener('change', updateAccountFields);
            } catch (e) {
                console.warn('Error wiring create_account checkbox', e);
            }
        });
    }

    function loadAndInjectModal(tempDiv, modalElement) {
        try {
            // The response contains a complete modal: <div class="modal fade"> ... </div>
            // We need to extract the modal-content and inject it into our placeholder modal
            const fullModal = tempDiv.querySelector('.modal');
            const sourceModalContent = fullModal ? fullModal.querySelector('.modal-content') : tempDiv.querySelector('.modal-content');
            
            if (!sourceModalContent) {
                console.error('Source modal-content not found in fetched HTML', tempDiv.innerHTML);
                const target = modalElement.querySelector('.modal-content');
                if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error: Form HTML malformed.</div></div>`;
                return;
            }

            // Find the target modal-content in our placeholder modal
            const targetModalContent = modalElement.querySelector('.modal-content');
            if (!targetModalContent) {
                console.error('Target modal-content not found in placeholder');
                return;
            }

            // Replace the entire modal-content HTML with the source's modal-content
            targetModalContent.innerHTML = sourceModalContent.innerHTML;
            
            // Run any inline scripts inside the injected content
            runInlineScripts(targetModalContent);

            // Call initialization if exists
            if (typeof initStudentRecordModal === 'function') {
                try { 
                    setTimeout(initStudentRecordModal, 100); 
                } catch(e){
                    console.warn('Error calling initStudentRecordModal', e);
                } 
            }
            
            // Attach form submit handler
            attachModalForm(modalElement);
        } catch (e) {
            console.error('Error injecting modal content', e);
            const target = modalElement.querySelector('.modal-content');
            if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error loading content. See console.</div></div>`;
        }
    }

    // Add modal loader
    const addBtn = document.querySelector('[data-bs-target="#addStudentRecordModal"]');
    if (addBtn) {
        addBtn.addEventListener('click', function(event) {
            const modalElement = document.getElementById('addStudentRecordModal');
            if (!modalElement) return;

            // Only load if modal content doesn't already contain a form
            if (!modalElement.querySelector('form')) {
                fetch('{% url "add" %}', { 
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } 
                })
                .then(resp => {
                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}`);
                    }
                    return resp.text();
                })
                .then(text => {
                    const tempDiv = htmlToElement(text);
                    loadAndInjectModal(tempDiv, modalElement);
                })
                .catch(err => {
                    console.error('Error loading add modal', err);
                    const target = modalElement.querySelector('.modal-content');
                    if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error loading form: ${err.message}</div></div>`;
                });
            }
        });
    }

    // Edit modal loader - handle dynamic modals per student
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-bs-target^="#editStudentRecordModal"]');
        if (!btn) return;

        const modalId = btn.getAttribute('data-bs-target').replace('#', '');
        const modalElement = document.getElementById(modalId);
        if (!modalElement) {
            console.error('Modal element not found:', modalId);
            return;
        }

        // Always fetch fresh modal HTML so the form is re-initialized every time
        e.preventDefault();
        e.stopPropagation();

        const studentId = modalId.replace('editStudentRecordModal', '');
        // Show spinner immediately so the user sees feedback
        try {
            const target = modalElement.querySelector('.modal-content');
            if (target) {
                target.innerHTML = `
                    <div class="modal-body text-center">
                        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>`;
            }
            const bootstrapModalImmediate = new bootstrap.Modal(modalElement);
            bootstrapModalImmediate.show();
        } catch (e) { /* ignore show errors */ }

        fetch(`/edit/${studentId}/`, { 
            headers: { 'X-Requested-With': 'XMLHttpRequest' } 
        })
        .then(resp => {
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }
            return resp.text();
        })
        .then(text => {
            const tempDiv = htmlToElement(text);
            loadAndInjectModal(tempDiv, modalElement);
            // ensure modal is shown after injection (in case it wasn't)
            try { new bootstrap.Modal(modalElement).show(); } catch(e) { /* ignore */ }
        })
        .catch(err => {
            console.error('Error loading edit modal', err);
            const target = modalElement.querySelector('.modal-content');
            if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error loading form: ${err.message}</div></div>`;
            try { new bootstrap.Modal(modalElement).show(); } catch(e) { /* ignore */ }
        });
    }, true); // Use capture phase to intercept before Bootstrap handles it

    // Helper: attach AJAX submit handler to modal form
    function attachModalForm(modalElement) {
        if (!modalElement) return;

        // small helper to read CSRF token from cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const form = modalElement.querySelector('form[data-modal-form="true"]') || modalElement.querySelector('form');
        if (!form) {
            console.warn('No form found in modal');
            return;
        }

        // avoid attaching multiple times
        if (form._ajaxAttached) return;
        form._ajaxAttached = true;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;

            const url = form.getAttribute('action') || window.location.href;
            const method = (form.getAttribute('method') || 'POST').toUpperCase();
            const formData = new FormData(form);

            const headers = { 'X-Requested-With': 'XMLHttpRequest' };
            const csrftoken = getCookie('csrftoken');
            if (csrftoken) headers['X-CSRFToken'] = csrftoken;

            fetch(url, {
                method: method,
                headers: headers,
                body: formData,
            })
            .then(response => {
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) return response.json();
                return response.text().then(html => ({ html }));
            })
            .then(result => {
                if (submitBtn) submitBtn.disabled = false;

                // If server returned HTML (form with validation errors), inject it
                if (result && result.html) {
                    const target = modalElement.querySelector('.modal-content');
                    if (target) {
                        target.innerHTML = result.html;
                        runInlineScripts(target);
                        // Reset attachment flag so new form can be reattached
                        const newForm = modalElement.querySelector('form');
                        if (newForm) newForm._ajaxAttached = false;
                        attachModalForm(modalElement);
                    }
                    return;
                }

                const data = result;
                if (data && data.success === true) {
                    // Close modal and refresh
                    try {
                        const bsModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                        bsModal.hide();
                    } catch (err) { console.warn('Error hiding modal', err); }

                    setTimeout(() => {
                        document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                        window.location.reload();
                    }, 200);
                } else {
                    const msg = data?.message || 'Save failed. Please check your form and try again.';
                    alert(msg);
                }
            })
            .catch(err => {
                if (submitBtn) submitBtn.disabled = false;
                console.error('Error submitting form:', err);
                alert('Error saving. See console for details: ' + err.message);
            });
        });

        // Reset form fields when modal is fully hidden (covers cancel button, backdrop click, ESC)
        modalElement.addEventListener('hidden.bs.modal', function() {
            try { form.reset(); } catch(e) { /* ignore */ }
            setTimeout(() => {
                if (!document.querySelector('.modal.show')) {
                    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                }
            }, 100);
        });
    }
});
</script>

<!-- Edit Student Record Modals - will be loaded dynamically -->
{% for student in page_obj %}
<div class="modal fade" id="editStudentRecordModal{{ student.id }}" tabindex="-1" aria-labelledby="editStudentRecordModal{{ student.id }}Label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}
