{% extends 'base.html' %}
{% load static %}
{% block title %}Student Record{% endblock %}

{% block content %}

<style>
    body {
        font-family: Inter, Poppins, sans-serif;
    }

    .user-folder-card {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        background: transparent;
    }

    .user-heading {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .user-heading h2 {
        color: #152E21;
        font-weight: 500;
    }
    .view-value { font-weight: 400; color: #1E1E1E; }

    /* Adviser alert styling (match faculty page) */
    .adviser-alert {
        color: #152E21;
        padding: 1.5rem;
        border-radius: 10px;
        border: 2px solid #152E21;
    }

    .adviser-alert h4 {
        color: #152E21;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }

    .adviser-alert ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .adviser-alert p {
        margin-top: 2rem;
    }

    .adviser-alert li {
        color: #152E21;
        margin-bottom: 0.25rem;
    }

    .adviser-alert small {
        color: #1a3a28;
        opacity: 0.9;
    }

.tab-search {
    background: #F6F5AE;
    display: flex;
    padding: 20px;
    gap: 8px;
    align-items: center;
}

.tab-search input[type="text"] {
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid #ccc;
    margin: 4px;
    font-family: Poppins, sans-serif;
    flex: 0.4;
}
.search-btn {
    background: #152E21;
    color: #F6F5AE;
    border: none;
    border-radius: 999px;
    padding: 8px 16px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: Poppins, sans-serif;
    font-size: 0.85rem;
    transition: background 0.2s;
}
.search-btn:hover {
    background: #1a3a28;
}

    .user-add-btn {
        border-radius: 999px;
        background: #b4d96b;
        color: #152E21;
        border: none;
        padding: 10px 16px;
        font-size: 0.85rem;
        font-family: Poppins, sans-serif;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        cursor: pointer;
    }

    .user-table-wrapper {
        width: 100%;
        overflow: hidden;
    }

    .user-table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
        margin: 0;
    }
    .user-table thead {
        background: #D9D9D9;
        color: #152E21;
        font-weight: bold;
    }
    
    .user-table thead th {
        padding: 20px;
        font-size: 0.8rem;
        text-align: left;
    }

    .user-table tbody td {
        padding: 16px;
        font-size: 0.8rem;
        background-color: #FFFFFF;
        word-wrap: break-word;
        white-space: normal;
        color: #1E1E1E;
    }
    .user-table thead th:nth-child(1),
    .user-table tbody td:nth-child(1) {
        width: 110px;
    }
    .user-table thead th:nth-child(2),
    .user-table tbody td:nth-child(2) {
        width: 150px;
    }

    .user-table thead th:nth-child(6),
    .user-table tbody td:nth-child(6) {
        width: 150px;
    }


    .user-table tbody tr:nth-child(even) {
        background: #fbfbfb;
    }
    .user-table tbody td.actions-cell {
        white-space: nowrap;
        max-width: none;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
    }
    .btn-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        padding: 0;
        border: none;
        background: #fff;
        cursor: pointer;
        text-decoration: none;
    }
    .btn-icon-view {
        background-color: #B7F29B;
        color: #1E1E1E;
    }
    .btn-icon-view:hover {
        background: #e8f5e9;
    }
    .btn-icon-edit {
        background-color: #B2C85C;
        color: #1E1E1E;
    }
    .btn-icon-edit:hover {
        background: #f5fadf;
    }
    .btn-icon-delete {
        background-color: #EF5353;
        color: #1E1E1E;
    }
    .btn-icon-delete:hover {
        background: #ffe5e1;
        color: #1E1E1E !important;
    }

    /* Pagination Styles */
    .pagination {
        margin-top: 2rem;
    }
    .pagination .page-link {
        background-color: #152E21;
        color: #F6F5AE;
        border: none;
        padding: 10px 18px;
        margin: 0 4px;
        border-radius: 6px;
        font-family: Poppins, sans-serif;
        font-size: 0.9rem;
        min-width: 45px;
        text-align: center;
        transition: background 0.2s;
    }
    .pagination .page-link:hover {
        background-color: #1a3a28;
        color: #F6F5AE;
    }
    .pagination .page-item.active .page-link {
        background-color: #152E21;
        color: #F6F5AE;
        font-weight: 600;
    }

    .user-data-table {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        .user-heading {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        .user-add-btn {
            width: 100%;
            justify-content: center;
        }
        .tab-search {
            padding: 15px;
            flex-wrap: wrap;
        }
        .tab-search input[type="text"] {
            flex: 1 1 100%;
            margin-bottom: 8px;
        }
        .search-btn {
            width: 100%;
            justify-content: center;
        }
        .user-table-wrapper {
            overflow-x: auto;
        }
        .user-table {
            min-width: 600px;
        }
        .user-table thead th,
        .user-table tbody td {
            font-size: 0.75rem;
        }
    }

    /* Card Styles for Mobile */
    .user-cards-wrapper {
        display: none;
    }
    .user-card {
        background: #FFFFFF;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .user-card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .user-card-row:last-child {
        border-bottom: none;
    }
    .user-card-label {
        font-weight: 600;
        color: #152E21;
        font-size: 0.85rem;
    }
    .user-card-value {
        color: #1E1E1E;
        font-size: 0.85rem;
        text-align: right;
    }
    .parent-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .parent-details small {
        color: #666;
        font-size: 0.75rem;
    }
    .user-card-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
        padding-top: 12px;
        border-top: none;
    }

    @media (max-width: 767px) {
        .user-folder-card {
            gap: 1rem;
        }
        .user-heading h2 {
            font-size: 1.3rem;
        }
        /* Hide table on mobile */
        .user-table-wrapper {
            display: none;
        }
        /* Show cards on mobile */
        .user-cards-wrapper {
            display: block;
            padding: 12px;
            background: #FFFFFF;
        }
        .pagination .page-link {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: 38px;
            margin: 0 2px;
        }
    }
</style>

<div class="container mt-4">
    <div class="user-folder-card">
        <div class="user-heading">
            <h2>Student Record</h2>
            <button type="button" class="user-add-btn" data-bs-toggle="modal" data-bs-target="#addStudentRecordModal">
                <i class="fas fa-user-plus"></i> Add Student
            </button>
        </div>

        <!-- Adviser Information Alert -->
        {% if is_adviser %}
        <div class="adviser-alert" role="alert">
            <h4 class="alert-heading"><i class="fas fa-star"></i> Adviser View</h4>
            <p>You are currently viewing students from the following section(s) you advise:</p>
            <ul>
                {% for section in advised_sections %}
                <li><strong>{{ section.grade }} - {{ section.name }}</strong></li>
                {% endfor %}
            </ul>
            <p class="mb-0"><small>Only students in your advised section(s) are displayed below.</small></p>
        </div>
        {% endif %}

        <div class="user-data-table">
            <form method="get" class="tab-search">
                <input type="text" name="search" placeholder="Search students..." value="{{ search }}">
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i> Search
                </button>
            </form>

            <div class="user-table-wrapper">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Full Name</th>
                            <th>Grade & Section</th>
                            <th>Gender & Age</th>
                            <th>Address</th>
                            <th>Parent & Contact</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for student in page_obj %}
                        <tr>
                            <td>{{ student.student_id }}</td>
                            <td>{{ student.fullname }}</td>
                            <td>{{ student.grade_and_section }}</td>
                            <td>{{ student.gender }}, {{ student.age }}</td>
                            <td>{{ student.address }}</td>
                            <td>
                                <div class="parent-details">
                                    <span>{{ student.parent }}</span>
                                    <small>{{ student.parent_contact }}</small>
                                </div>
                            </td>
                            <td>{{ student.status }}</td>
                            <td class="actions-cell">
                            <div class="action-buttons">
                                <button type="button" class="btn-icon btn-icon-view"
                                        data-bs-toggle="modal"
                                        data-bs-target="#mymodal{{student.id}}"
                                        title="View">
                                    <i class="fa-regular fa-eye"></i>
                                </button>

<!--      modal view student -->
    <div class="modal fade" id="mymodal{{student.id}}" tabindex="-1" aria-labelledby="mymodalLabel{{student.id}}" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content user-modal">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user fa-fw me-2"></i>Student: {{ student.fullname}}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-id-badge me-2"></i>ID</label>
                        <div><span class="view-value">{{ student.student_id }}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-user me-2"></i>Full Name</label>
                        <div><span class="view-value">{{ student.fullname }}</span></div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-school me-2"></i>Grade & Section</label>
                        <div><span class="view-value">{{ student.grade_and_section }}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-venus-mars me-2"></i>Gender</label>
                        <div><span class="view-value">{{ student.gender }}</span></div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-birthday-cake me-2"></i>Age</label>
                        <div><span class="view-value">{{ student.age }}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-circle-notch me-2"></i>Status</label>
                        <div><span class="view-value">{{ student.status }}</span></div>
                    </div>

                    <div class="col-12">
                        <label class="form-label"><i class="fas fa-map-marker-alt me-2"></i>Address</label>
                        <div><span class="view-value">{{ student.address }}</span></div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-user-friends me-2"></i>Guardian</label>
                        <div><span class="view-value">{{ student.parent }}</span></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-phone me-2"></i>Guardian Contact</label>
                        <div><span class="view-value">{{ student.parent_contact }}</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--      modal delete student-->
      <div class="modal" id ="delete{{student.id}}" tabindex="-1" aria-labelledby="mymodalLabel{{student.id}}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content user-modal">
      <div class="modal-header">
        <h5 class="modal-title">
          Student: {{ student.fullname}}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true"></span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this student?</p>
      </div>
     <div class="modal-footer">
  <form action="{% url 'delete' student.id %}" method="POST">
    {% csrf_token %}
    <input type="submit" class="btn btn-danger" value="Delete">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  </form>
</div>

      </div>
    </div>
  </div>
</div>
                                <button type="button" class="btn-icon btn-icon-edit"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editStudentRecordModal{{ student.id }}"
                                        data-modal-load="{% url 'edit' student.id %}"
                                        title="Edit">
                                    <i class="fa-regular fa-pen-to-square"></i>
                                </button>
                                <button type="button" class="btn-icon btn-icon-delete"
                                        data-bs-toggle="modal"
                                        data-bs-target="#delete{{student.id}}"
                                        title="Delete">
                                    <i class="fa-regular fa-trash-can"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards View -->
            <div class="user-cards-wrapper">
                {% for student in page_obj %}
                    <div class="user-card">
                        <div class="user-card-row">
                            <span class="user-card-label">Student ID</span>
                            <span class="user-card-value">{{ student.student_id }}</span>
                        </div>
                    <div class="user-card-row">
                        <span class="user-card-label">Full Name</span>
                        <span class="user-card-value">{{ student.fullname}}</span>
                    </div>
                    <div class="user-card-row">
                        <span class="user-card-label">Grade & Section</span>
                        <span class="user-card-value">{{ student.grade_and_section}}</span>
                    </div>
                    <div class="user-card-row">
                        <span class="user-card-label">Gender & Age</span>
                        <span class="user-card-value">{{ student.gender }}, {{ student.age}}</span>
                    </div>
                    <div class="user-card-row">
                        <span class="user-card-label">Address</span>
                        <span class="user-card-value">{{ student.address}}</span>
                    </div>
                    <div class="user-card-row">
                        <span class="user-card-label">Parent & Contact</span>
                        <span class="user-card-value parent-details">
                            <span>{{ student.parent}}</span>
                            <small>{{ student.parent_contact}}</small>
                        </span>
                    </div>
                    <div class="user-card-row">
                        <span class="user-card-label">Status</span>
                        <span class="user-card-value">{{ student.status}}</span>
                    </div>
                    <div class="user-card-actions">
                        <button type="button" class="btn-icon btn-icon-view"
                                data-bs-toggle="modal"
                                data-bs-target="#mymodal{{student.id}}"
                                title="View">
                            <i class="fa-regular fa-eye"></i>
                        </button>
                        <button type="button" class="btn-icon btn-icon-edit"
                                data-bs-toggle="modal"
                                data-bs-target="#editStudentRecordModal{{ student.id }}"
                                data-modal-load="{% url 'edit' student.id %}"
                                title="Edit">
                            <i class="fa-regular fa-pen-to-square"></i>
                        </button>
                        <button type="button" class="btn-icon btn-icon-delete"
                                data-bs-toggle="modal"
                                data-bs-target="#delete{{student.id}}"
                                title="Delete">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Pagination -->
{% if page_obj %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-3">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}">Previous</a>
            </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}">Next</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}


<!-- Add Student Modal - will be loaded dynamically -->
<div class="modal fade" id="addStudentRecordModal" tabindex="-1" aria-labelledby="addStudentRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content user-modal">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Modal loading helpers and AJAX submit handler
document.addEventListener('DOMContentLoaded', function() {
    function htmlToElement(html) {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        return temp;
    }

    function runInlineScripts(container) {
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
            try {
                const newScript = document.createElement('script');
                if (oldScript.src) {
                    newScript.src = oldScript.src;
                    newScript.async = false;
                    document.head.appendChild(newScript);
                } else {
                    newScript.text = oldScript.textContent;
                    document.body.appendChild(newScript);
                    document.body.removeChild(newScript);
                }
            } catch (e) {
                console.error('Error running inline script', e);
            }
        });
    }

    // Global initializer used by both Add and Edit modals to wire grade->section behavior
    function initStudentRecordModal() {
        // For each grade select inside modal-content, attach change handler
        document.querySelectorAll('[id^="id_grade_level_record"]').forEach(function(gradeSelect) {
            const modalContent = gradeSelect.closest('.modal-content') || document;
            const sectionSelect = modalContent.querySelector('[id^="id_section_record"]');
            if (!sectionSelect) return;

            // On change: fetch sections for selected grade
            gradeSelect.addEventListener('change', function() {
                const grade = this.value;
                if (!grade) return;
                fetch(`/api/sections/?grade=${encodeURIComponent(grade)}`)
                    .then(r => r.json())
                    .then(data => {
                        sectionSelect.innerHTML = '<option value="">Select Section</option>';
                        if (data.sections && data.sections.length) {
                            data.sections.forEach(s => {
                                const opt = document.createElement('option');
                                opt.value = s.id;
                                opt.text = s.name;
                                sectionSelect.appendChild(opt);
                            });
                        }
                    })
                    .catch(err => console.error('Error fetching sections', err));
            });

            // On init: if there are no options (or only placeholder), try to populate based on current grade value
            const hasRealOptions = Array.from(sectionSelect.options).some(o => o.value);
            if (!hasRealOptions && gradeSelect.value) {
                const currentGrade = gradeSelect.value;
                // attempt to get the original section name from modal dataset
                const modalRoot = gradeSelect.closest('.modal');
                const currentSectionName = modalRoot ? (modalRoot.dataset.currentSection || '') : '';
                fetch(`/api/sections/?grade=${encodeURIComponent(currentGrade)}`)
                    .then(r => r.json())
                    .then(data => {
                        sectionSelect.innerHTML = '<option value="">Select Section</option>';
                        if (data.sections && data.sections.length) {
                            data.sections.forEach(s => {
                                const opt = document.createElement('option');
                                opt.value = s.id;
                                opt.text = s.name;
                                if (currentSectionName && s.name === currentSectionName) opt.selected = true;
                                sectionSelect.appendChild(opt);
                            });
                        }
                    })
                    .catch(err => console.error('Error fetching sections', err));
            }
        });

        // Wire 'Also create user account' checkbox to show/hide account fields inside the modal
        document.querySelectorAll('.modal-content').forEach(modalContent => {
            try {
                const checkbox = modalContent.querySelector('input[name="create_account"]');
                const accountFields = modalContent.querySelector('#account_fields');
                const passwordInput = modalContent.querySelector('input[name="password"], input#password');
                if (!checkbox || !accountFields) return;

                const usernameInput = modalContent.querySelector('input[name="username"], input#username');
                const updateAccountFields = () => {
                    if (checkbox.checked) {
                        accountFields.style.display = '';
                        if (passwordInput) passwordInput.required = true;
                        if (usernameInput) usernameInput.required = true;
                    } else {
                        accountFields.style.display = 'none';
                        if (passwordInput) passwordInput.required = false;
                        if (usernameInput) usernameInput.required = false;
                    }
                };

                // initialize state
                updateAccountFields();
                // listen for changes
                checkbox.addEventListener('change', updateAccountFields);
            } catch (e) {
                console.warn('Error wiring create_account checkbox', e);
            }
        });
    }

    function loadAndInjectModal(tempDiv, modalElement) {
        try {
            // The response contains a complete modal: <div class="modal fade"> ... </div>
            // We need to extract the modal-content and inject it into our placeholder modal
            const fullModal = tempDiv.querySelector('.modal');
            const sourceModalContent = fullModal ? fullModal.querySelector('.modal-content') : tempDiv.querySelector('.modal-content');
            
            if (!sourceModalContent) {
                console.error('Source modal-content not found in fetched HTML', tempDiv.innerHTML);
                const target = modalElement.querySelector('.modal-content');
                if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error: Form HTML malformed.</div></div>`;
                return;
            }

            // Find the target modal-content in our placeholder modal
            const targetModalContent = modalElement.querySelector('.modal-content');
            if (!targetModalContent) {
                console.error('Target modal-content not found in placeholder');
                return;
            }

            // If the source modal requests a light backdrop, paint any existing/backdrops and
            // observe for newly-added backdrop nodes so they get the same color while open.
            try {
                const sourceModal = fullModal || tempDiv.querySelector('.modal');
                if (sourceModal && sourceModal.getAttribute && sourceModal.getAttribute('data-light-backdrop') === 'true') {
                    const paint = (bd) => { try { bd.style.backgroundColor = 'rgba(0,0,0,0.18)'; } catch(e){} };
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(paint);

                    // Observe DOM for newly-added backdrop nodes (Bootstrap may add them after show)
                    const mo = new MutationObserver((mutations) => {
                        for (const m of mutations) {
                            for (const n of m.addedNodes) {
                                if (n && n.nodeType === 1 && n.classList && n.classList.contains('modal-backdrop')) {
                                    paint(n);
                                }
                            }
                        }
                    });
                    mo.observe(document.body, { childList: true });

                    // Disconnect the observer once this modal is hidden so we don't leak observers
                    modalElement.addEventListener('hidden.bs.modal', function cleanup() {
                        try { mo.disconnect(); } catch(e) {}
                    }, { once: true });
                }
            } catch (e) { console.warn('backdrop paint error', e); }

            // Inject the source modal-content into a wrapper so we can animate it
            targetModalContent.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'injected';
            wrapper.innerHTML = sourceModalContent.innerHTML;
            targetModalContent.appendChild(wrapper);
            // Ensure modal-scoped styles apply
            targetModalContent.classList.add('user-modal');

            // Run any inline scripts inside the injected content
            runInlineScripts(wrapper);
            // trigger slide-in animation
            requestAnimationFrame(() => wrapper.classList.add('show'));

            // Call initialization if exists
            if (typeof initStudentRecordModal === 'function') {
                try { 
                    setTimeout(initStudentRecordModal, 100); 
                } catch(e){
                    console.warn('Error calling initStudentRecordModal', e);
                } 
            }
            
            // Attach form submit handler
            attachModalForm(modalElement);
        } catch (e) {
            console.error('Error injecting modal content', e);
            const target = modalElement.querySelector('.modal-content');
            if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error loading content. See console.</div></div>`;
        }
    }

    // Add modal loader
    const addBtn = document.querySelector('[data-bs-target="#addStudentRecordModal"]');
    if (addBtn) {
        addBtn.addEventListener('click', function(event) {
            const modalElement = document.getElementById('addStudentRecordModal');
            if (!modalElement) return;

            // Only load if modal content doesn't already contain a form
            if (!modalElement.querySelector('form')) {
                fetch('{% url "add" %}', { 
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } 
                })
                .then(resp => {
                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}`);
                    }
                    return resp.text();
                })
                .then(text => {
                    const tempDiv = htmlToElement(text);
                    loadAndInjectModal(tempDiv, modalElement);
                })
                .catch(err => {
                    console.error('Error loading add modal', err);
                    const target = modalElement.querySelector('.modal-content');
                    if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error loading form: ${err.message}</div></div>`;
                });
            }
        });
    }

    // Edit modal loader - handle dynamic modals per student
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-bs-target^="#editStudentRecordModal"]');
        if (!btn) return;

        const modalId = btn.getAttribute('data-bs-target').replace('#', '');
        const modalElement = document.getElementById(modalId);
        if (!modalElement) {
            console.error('Modal element not found:', modalId);
            return;
        }

        // Always fetch fresh modal HTML so the form is re-initialized every time
        e.preventDefault();
        e.stopPropagation();

        const studentId = modalId.replace('editStudentRecordModal', '');
        // Show spinner immediately so the user sees feedback
        try {
            const target = modalElement.querySelector('.modal-content');
            if (target) {
                target.innerHTML = `
                    <div class="modal-body text-center">
                        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>`;
            }
            const bootstrapModalImmediate = new bootstrap.Modal(modalElement);
            bootstrapModalImmediate.show();
        } catch (e) { /* ignore show errors */ }

        fetch(`/edit/${studentId}/`, { 
            headers: { 'X-Requested-With': 'XMLHttpRequest' } 
        })
        .then(resp => {
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }
            return resp.text();
        })
        .then(text => {
            const tempDiv = htmlToElement(text);
            loadAndInjectModal(tempDiv, modalElement);
            // ensure modal is shown after injection (in case it wasn't)
            try { new bootstrap.Modal(modalElement).show(); } catch(e) { /* ignore */ }
        })
        .catch(err => {
            console.error('Error loading edit modal', err);
            const target = modalElement.querySelector('.modal-content');
            if (target) target.innerHTML = `<div class="modal-body"><div class="alert alert-danger">Error loading form: ${err.message}</div></div>`;
            try { new bootstrap.Modal(modalElement).show(); } catch(e) { /* ignore */ }
        });
    }, true); // Use capture phase to intercept before Bootstrap handles it

    // Helper: attach AJAX submit handler to modal form
    function attachModalForm(modalElement) {
        if (!modalElement) return;

        // small helper to read CSRF token from cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const form = modalElement.querySelector('form[data-modal-form="true"]') || modalElement.querySelector('form');
        if (!form) {
            console.warn('No form found in modal');
            return;
        }

        // avoid attaching multiple times
        if (form._ajaxAttached) return;
        form._ajaxAttached = true;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;

            const url = form.getAttribute('action') || window.location.href;
            const method = (form.getAttribute('method') || 'POST').toUpperCase();
            const formData = new FormData(form);

            const headers = { 'X-Requested-With': 'XMLHttpRequest' };
            const csrftoken = getCookie('csrftoken');
            if (csrftoken) headers['X-CSRFToken'] = csrftoken;

            fetch(url, {
                method: method,
                headers: headers,
                body: formData,
            })
            .then(response => {
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) return response.json();
                return response.text().then(html => ({ html }));
            })
            .then(result => {
                if (submitBtn) submitBtn.disabled = false;

                // If server returned HTML (form with validation errors), inject it
                if (result && result.html) {
                    const target = modalElement.querySelector('.modal-content');
                    if (target) {
                        target.innerHTML = result.html;
                        runInlineScripts(target);
                        // Reset attachment flag so new form can be reattached
                        const newForm = modalElement.querySelector('form');
                        if (newForm) newForm._ajaxAttached = false;
                        attachModalForm(modalElement);
                    }
                    return;
                }

                const data = result;
                if (data && data.success === true) {
                    // Close modal and refresh
                    try {
                        const bsModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                        bsModal.hide();
                    } catch (err) { console.warn('Error hiding modal', err); }

                    setTimeout(() => {
                        document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                        window.location.reload();
                    }, 200);
                } else {
                    const msg = data?.message || 'Save failed. Please check your form and try again.';
                    alert(msg);
                }
            })
            .catch(err => {
                if (submitBtn) submitBtn.disabled = false;
                console.error('Error submitting form:', err);
                alert('Error saving. See console for details: ' + err.message);
            });
        });

        // Reset form fields when modal is fully hidden (covers cancel button, backdrop click, ESC)
        modalElement.addEventListener('hidden.bs.modal', function() {
            try { form.reset(); } catch(e) { /* ignore */ }
            setTimeout(() => {
                if (!document.querySelector('.modal.show')) {
                    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                }
            }, 100);
        });
    }
});
</script>

<!-- Edit Student Record Modals - will be loaded dynamically -->
{% for student in page_obj %}
<div class="modal fade" id="editStudentRecordModal{{ student.id }}" tabindex="-1" aria-labelledby="editStudentRecordModal{{ student.id }}Label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content user-modal">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
// Move inline small modals (view/delete) out to document.body to avoid clipping on mobile
document.addEventListener('DOMContentLoaded', function() {
    try {
        const inlineModals = document.querySelectorAll('.modal[id^="mymodal"], .modal[id^="delete"]');
        inlineModals.forEach(function(m) {
            if (m.parentElement && m.parentElement !== document.body) {
                document.body.appendChild(m);
            }
        });
    } catch (e) {
        console && console.warn && console.warn('move-inline-modals error', e);
    }
});
</script>

{% endblock %}
